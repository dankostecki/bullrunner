<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BULL RUNNER - High Sensitivity</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        :root {
            --sat: env(safe-area-inset-top);
            --sar: env(safe-area-inset-right);
            --sab: env(safe-area-inset-bottom);
            --sal: env(safe-area-inset-left);
        }

        body {
            margin: 0; padding: 0; overflow: hidden;
            background-color: #000; font-family: 'Segoe UI', sans-serif;
            touch-action: none; user-select: none; -webkit-user-select: none;
        }

        #game-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364);
        }

        canvas { display: block; touch-action: none; }

        #orientation-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f2027; z-index: 9999; display: none;
            flex-direction: column; justify-content: center; align-items: center;
            color: #39FF14; text-align: center; font-family: 'Press Start 2P', cursive;
            padding: 20px; box-sizing: border-box;
        }

        #orientation-overlay .icon { font-size: 50px; margin-bottom: 20px; animation: rotateDevice 2s infinite ease-in-out; }
        @keyframes rotateDevice { 0% { transform: rotate(0deg); } 50% { transform: rotate(-90deg); } 100% { transform: rotate(0deg); } }
        @media screen and (orientation: portrait) { #orientation-overlay { display: flex; } }

        .ingame-logo {
            position: absolute; top: max(20px, var(--sat)); left: 50%;
            transform: translateX(-50%); width: 120px; height: auto;
            z-index: 9; opacity: 0.4; pointer-events: none;
        }

        .score-board { position: absolute; top: max(20px, var(--sat)); left: max(20px, var(--sal)); z-index: 10; }
        .high-score { position: absolute; top: max(20px, var(--sat)); right: max(20px, var(--sar)); color: #94a3b8; font-size: 16px; z-index: 10; font-family: 'Courier New', monospace; }

        .main-score { color: #39FF14; font-size: 18px; text-shadow: 0 0 15px #39FF14; font-family: 'Press Start 2P', cursive; margin-bottom: 8px; }
        .sub-score-container { display: flex; flex-direction: column; gap: 4px; }
        .sub-score { color: #86efac; font-size: 10px; font-family: 'Press Start 2P', cursive; opacity: 0.9; }

        .rank-tracker {
            margin-top: 15px; width: 220px; background: rgba(15, 23, 42, 0.6);
            padding: 8px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; flex-direction: column; gap: 5px;
        }
        
        .rank-header { display: flex; align-items: center; justify-content: space-between; }
        .rank-icon { font-size: 16px; }
        .rank-name-live { font-family: 'Press Start 2P', cursive; font-size: 9px; color: #fff; text-transform: uppercase; }
        .rank-progress-live-bg { width: 100%; height: 4px; background: rgba(255,255,255,0.15); border-radius: 2px; overflow: hidden; }
        .rank-progress-live-fill { height: 100%; width: 0%; background: #fff; transition: width 0.3s ease-out; }

        .stock-ticker {
            position: absolute; top: max(92px, calc(var(--sat) + 120px)); width: 100%;
            text-align: center; color: rgba(57, 255, 20, 0.4); font-family: 'Courier New', monospace;
            font-size: 11px; z-index: 5; letter-spacing: 1px;
        }

        .bonus-text {
            position: absolute; top: 20%; left: 50%; transform: translate(-50%, 0); 
            color: #ffd700; font-family: 'Press Start 2P', cursive; font-size: 24px;
            text-shadow: 0 0 25px #ffd700; opacity: 0; z-index: 20; text-align: center;
        }
        .bonus-active { animation: floatUp 2s forwards; }
        @keyframes floatUp { 0% { opacity: 0; transform: translate(-50%, 50px) scale(0.5); } 10% { opacity: 1; transform: translate(-50%, 0) scale(1.2); } 100% { opacity: 0; transform: translate(-50%, -100px); } }

        .speed-wrapper { position: absolute; bottom: max(30px, var(--sab)); left: 50%; transform: translateX(-50%); width: 300px; text-align: center; z-index: 10; }
        .speed-container { width: 100%; height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; overflow: hidden; }
        .speed-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #39FF14, #22d3ee); transition: width 0.1s linear; }

        #startScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #050a10; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 200; 
        }

        #startScreen h1 { font-size: 80px; color: #39FF14; text-align: center; font-family: 'Press Start 2P', cursive; }
        #startScreen p { color: #cbd5e1; margin-bottom: 50px; text-align: center; }

        #gameOverScreen {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 500px; background: rgba(15, 23, 42, 0.95); padding: 40px;
            border-radius: 12px; border: 1px solid #39FF14; display: flex; flex-direction: column;
            align-items: center; z-index: 150; backdrop-filter: blur(10px);
        }

        #finalScore { font-size: 36px; color: #39FF14; font-family: 'Press Start 2P', cursive; margin: 15px 0; }
        button {
            background: linear-gradient(135deg, #39FF14 0%, #008f11 100%);
            border: none; padding: 16px 45px; color: #000; font-weight: 800;
            border-radius: 50px; cursor: pointer; text-transform: uppercase;
        }

        .hidden { opacity: 0; visibility: hidden; pointer-events: none; }

        #warmupOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(8px);
            z-index: 300; display: flex; align-items: center; justify-content: center;
        }

        #countdownOverlay {
            position: fixed; inset: 0; z-index: 190; display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.25); backdrop-filter: blur(6px);
        }
        .countdown-text { font-family: 'Press Start 2P', cursive; color: #39FF14; font-size: 52px; }

        #pauseOverlay {
            position: fixed; inset: 0; z-index: 180; display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.35); backdrop-filter: blur(6px);
        }
    </style>
</head>
<body>

    <div id="orientation-overlay">
        <div class="icon">üì±</div>
        <div>OBR√ìƒÜ TELEFON</div>
    </div>

    <div id="warmupOverlay" class="hidden">
        <div style="text-align: center; width: 300px;">
            <div style="color: #39FF14; font-family: 'Press Start 2P'; font-size: 16px; margin-bottom: 10px;">≈ÅADOWANIE RYNKU...</div>
            <div style="width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                <div id="warmupBarFill" style="height: 100%; width: 0%; background: #39FF14;"></div>
            </div>
        </div>
    </div>

    <div id="game-container"></div>
    
    <audio id="bgIntro" loop><source src="intro.mp3" type="audio/mp3"></audio>
    <audio id="bgMusic" loop><source src="music.mp3" type="audio/mp3"></audio>
    <audio id="bgEnd" loop><source src="outro.mp3" type="audio/mp3"></audio>

    <img src="logo.png" class="ingame-logo" alt="" onerror="this.style.display='none'">
    
    <div class="stock-ticker">BTC ‚ñ≤ 5.2% &nbsp;|&nbsp; GOLD ‚ñ≤ 1.8% &nbsp;|&nbsp; AI ‚ñ≤ 12.4%</div>

    <div class="score-board">
        <div class="main-score">PORTFOLIO: <span id="scoreVal">$0</span></div>
        <div class="sub-score-container">
            <div class="sub-score">Zysk: <span id="coinScoreVal">$0</span></div>
            <div class="sub-score">Bonus czasu: <span id="timeScoreVal">$0</span></div>
        </div>
        <div id="liveRankTracker" class="rank-tracker">
            <div class="rank-header"><span id="liveRankIcon">üë∂</span><span id="liveRankName" class="rank-name-live">NOWICJUSZ</span></div>
            <div class="rank-progress-live-bg"><div id="liveRankFill" class="rank-progress-live-fill"></div></div>
        </div>
    </div>
    
    <div id="bonusMsg" class="bonus-text">DYWIDENDA +$5000</div>
    <div class="high-score">REKORD: <span id="highScoreVal">$0</span></div>

    <div class="speed-wrapper">
        <div class="speed-container"><div id="speedBar" class="speed-bar"></div></div>
    </div>

    <div id="startScreen">
        <h1>BULL<br>RUNNER</h1>
        <p>Hossa wraca na salony.<br>Buduj fortunƒô w trybie pe≈Çnoekranowym.</p>
        <button id="startBtn">INWESTUJ</button>
    </div>

    <div id="gameOverScreen" class="hidden">
        <h1 style="color: #39FF14; font-family: 'Press Start 2P';">MARGIN CALL</h1>
        <div id="rankBadge" style="font-size: 60px;"></div>
        <div id="finalRank" style="font-family: 'Press Start 2P'; color: #fff; margin: 10px 0;"></div>
        <div id="finalScore">$0</div>
        <button id="restartBtn">ODR√ìB STRATY</button>
        <button id="menuBtn" style="margin-top: 15px; background: transparent; border: 2px solid #39FF14; color: #39FF14;">MENU</button>
    </div>

    <div id="countdownOverlay" class="hidden"><div class="countdown-text" id="countdownText">3</div></div>
    <div id="pauseOverlay" class="hidden"><div style="color: #39FF14; font-family: 'Press Start 2P';">PAUZA - KLIKNIJ BY WR√ìCIƒÜ</div></div>

    <script>
        const RANKS = [
            { limit: 0, name: "NOWICJUSZ", color: "#bdc3c7", icon: "üë∂" }, 
            { limit: 15000, name: "INWESTOR", color: "#86efac", icon: "üìà" }, 
            { limit: 45000, name: "TRADER", color: "#00ffff", icon: "üíº" }, 
            { limit: 90000, name: "REKIN", color: "#39FF14", icon: "ü¶à" }, 
            { limit: 150000, name: "WILK", color: "#ffd700", icon: "üê∫" }  
        ];

        const Assets = {
            geometries: {}, materials: {},
            init: function() {
                this.geometries.coin = new THREE.PlaneGeometry(1.8, 1.8);
                this.geometries.bearBody = new THREE.BoxGeometry(2.5, 1.6, 1.8);
                this.geometries.bearHead = new THREE.BoxGeometry(1.6, 1.2, 1.2);
                this.geometries.bearEar = new THREE.BoxGeometry(0.3, 0.3, 0.2);
                this.geometries.bearLeg = new THREE.BoxGeometry(0.8, 1.2, 0.8);
                this.geometries.arrowCone = new THREE.ConeGeometry(0.6, 1.2, 4);
                this.geometries.arrowBox = new THREE.BoxGeometry(0.4, 1.2, 0.4);
                this.geometries.gem = new THREE.OctahedronGeometry(0.7, 0);
                this.geometries.building = new THREE.BoxGeometry(1, 1, 1); 
                this.geometries.particle = new THREE.BoxGeometry(1, 1, 1);
                
                this.materials.coin = new THREE.MeshBasicMaterial({ transparent: true, side: THREE.DoubleSide, depthWrite: false });
                this.materials.bear = new THREE.MeshStandardMaterial({ color: 0x880000, roughness: 0.5 });
                this.materials.arrow = new THREE.MeshStandardMaterial({ color: 0xcc0000, emissive: 0x550000 });
                this.materials.gem = new THREE.MeshStandardMaterial({ color: 0x00ffff, emissive: 0x00ffff, emissiveIntensity: 0.5 });
            }
        };

        class AudioManager {
            constructor() {
                this.ctx = null;
                this.introTrack = document.getElementById('bgIntro');
                this.gameTrack = document.getElementById('bgMusic');
                this.endTrack = document.getElementById('bgEnd');
                this.targetBgmVol = 0.06;
            }
            init() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); if (this.ctx.state === 'suspended') this.ctx.resume(); }
            fade(audioEl, startVol, endVol, duration) {
                if(!audioEl) return;
                if(audioEl.fadeInterval) clearInterval(audioEl.fadeInterval);
                const steps = duration / 50;
                const volStep = (endVol - startVol) / steps;
                let currentStep = 0;
                audioEl.volume = startVol;
                if(endVol > 0 && audioEl.paused) audioEl.play().catch(() => {});
                audioEl.fadeInterval = setInterval(() => {
                    currentStep++;
                    audioEl.volume = Math.max(0, Math.min(1, startVol + (volStep * currentStep)));
                    if(currentStep >= steps) { clearInterval(audioEl.fadeInterval); if(endVol === 0) { audioEl.pause(); audioEl.currentTime = 0; } }
                }, 50);
            }
            playIntro() { this.fade(this.gameTrack, this.gameTrack.volume, 0, 500); this.fade(this.introTrack, 0, this.targetBgmVol, 1000); }
            transitionToGame() { this.fade(this.introTrack, this.introTrack.volume, 0, 500); this.fade(this.gameTrack, 0, this.targetBgmVol, 1000); }
            transitionToGameOver() { this.fade(this.gameTrack, this.gameTrack.volume, 0, 500); this.fade(this.endTrack, 0, this.targetBgmVol, 1000); }
            playTone(freq, type, duration, vol = 0.1) {
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                gain.gain.setValueAtTime(vol, this.ctx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + duration);
            }
            playCoin() { this.playTone(1200, 'sine', 0.1); }
            playBonus() { this.playTone(880, 'square', 0.3); }
            playPowerUp() { this.playTone(400, 'sawtooth', 0.5); }
            playCrash() { this.playTone(100, 'sawtooth', 0.4); }
        }

        const audioManager = new AudioManager();
        let scene, camera, renderer, cubeCamera, cubeRenderTarget, buildingMaterial;
        let player, ground, isPlaying = false, isPaused = false, score = 0, coinScore = 0, timeScore = 0;
        let gameSpeed = 0.5, obstacles = [], sceneryObjects = [], particles = [];
        let mousePosNorm = 0.5, lastFrameTime = performance.now(), invulnerableUntil = 0;
        let cubeUpdateCounter = 0, cubeUpdateEvery = 40;

        function init() {
            Assets.init();
            scene = new THREE.Scene(); scene.fog = new THREE.Fog(0x2c5364, 30, 95);
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 150);
            camera.position.set(0, 5, 9); camera.lookAt(0, 0, -10);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.getElementById('game-container').appendChild(renderer.domElement);

            cubeRenderTarget = new THREE.WebGLCubeRenderTarget(256);
            cubeCamera = new THREE.CubeCamera(1, 100, cubeRenderTarget);
            buildingMaterial = new THREE.MeshPhysicalMaterial({ color: 0x2c3e50, metalness: 0.9, roughness: 0.1, envMap: cubeRenderTarget.texture });

            const sun = new THREE.DirectionalLight(0xffffff, 1.5); sun.position.set(-20, 50, 20); sun.castShadow = true; scene.add(sun);
            scene.add(new THREE.AmbientLight(0xffffff, 0.4));

            const groundGeo = new THREE.PlaneGeometry(300, 600);
            ground = new THREE.Mesh(groundGeo, new THREE.MeshPhysicalMaterial({ color: 0x0a1128, roughness: 0.4 }));
            ground.rotation.x = -Math.PI / 2; ground.receiveShadow = true; scene.add(ground);

            createPlayer();
            animate();
            window.addEventListener('resize', onWindowResize);
            document.getElementById('startBtn').addEventListener('click', startGame);
            document.getElementById('restartBtn').addEventListener('click', startGame);
            document.getElementById('menuBtn').addEventListener('click', () => { location.reload(); });
        }

        function createPlayer() {
            player = new THREE.Group();
            const body = new THREE.Mesh(new THREE.BoxGeometry(1.6, 1.5, 1.8), new THREE.MeshStandardMaterial({color: 0x111111}));
            body.position.y = 1.3; body.castShadow = true; player.add(body);
            scene.add(player);
        }

        class Particle3D {
            constructor(x, y, z, color) {
                this.mesh = new THREE.Mesh(Assets.geometries.particle, new THREE.MeshBasicMaterial({ color: color, transparent: true, opacity: 0.8 }));
                this.mesh.scale.set(0.15, 0.15, 0.15); this.mesh.position.set(x, y, z);
                this.vel = new THREE.Vector3((Math.random()-0.5)*0.5, Math.random()*0.5, (Math.random()-0.5)*0.5);
                this.life = 1.0; scene.add(this.mesh);
            }
            update() {
                this.mesh.position.add(this.vel); this.vel.y -= 0.02; this.life -= 0.03;
                if (this.life <= 0) { scene.remove(this.mesh); return false; }
                return true;
            }
        }

        class Obstacle3D {
            constructor(type) {
                this.type = type; this.passed = false;
                const xPos = (Math.random() * 14) - 7;
                if (type === 0) this.mesh = new THREE.Mesh(Assets.geometries.coin, Assets.materials.coin);
                else if (type === 3) this.mesh = new THREE.Mesh(Assets.geometries.gem, Assets.materials.gem);
                else this.mesh = new THREE.Mesh(Assets.geometries.bearBody, Assets.materials.bear);
                this.mesh.position.set(xPos, 1.2, -110); scene.add(this.mesh);
            }
            update(speed) { this.mesh.position.z += speed; if (this.mesh.position.z > 5) { scene.remove(this.mesh); return true; } return false; }
        }

        function checkCollisions() {
            const pBox = new THREE.Box3().setFromObject(player).expandByScalar(-0.3);
            for (let i = obstacles.length - 1; i >= 0; i--) {
                const obs = obstacles[i];
                const oBox = new THREE.Box3().setFromObject(obs.mesh);
                if (pBox.intersectsBox(oBox)) {
                    if (obs.type === 0) {
                        coinScore += 1000; audioManager.playCoin();
                        for(let k=0; k<10; k++) particles.push(new Particle3D(obs.mesh.position.x, 1, obs.mesh.position.z, 0x39FF14));
                    } else if (obs.type === 3) {
                        score += 5000; audioManager.playPowerUp();
                        // Naprawa: Dodane czƒÖsteczki dla diamentu
                        for(let k=0; k<25; k++) particles.push(new Particle3D(obs.mesh.position.x, 1, obs.mesh.position.z, 0x00ffff));
                    } else if (performance.now() > invulnerableUntil) {
                        gameOver(); return;
                    }
                    scene.remove(obs.mesh); obstacles.splice(i, 1);
                }
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            if (isPlaying && !isPaused) {
                gameSpeed = Math.min(2.4, gameSpeed + 0.0001);
                player.position.x += ((mousePosNorm * 14 - 7) - player.position.x) * 0.2;
                
                // Naprawa Feedback Loop: Ukrywamy obiekty z envMap przed aktualizacjƒÖ kamery
                if (cubeUpdateCounter++ % cubeUpdateEvery === 0) {
                    ground.visible = false;
                    cubeCamera.update(renderer, scene);
                    ground.visible = true;
                }

                if (Math.random() < 0.05) obstacles.push(new Obstacle3D(Math.random() > 0.9 ? 3 : (Math.random() > 0.5 ? 0 : 1)));
                for (let i = obstacles.length - 1; i >= 0; i--) if (obstacles[i].update(gameSpeed)) obstacles.splice(i, 1);
                for (let i = particles.length - 1; i >= 0; i--) if (!particles[i].update()) particles.splice(i, 1);
                
                checkCollisions();
                updateUI();
            }
            renderer.render(scene, camera);
        }

        function updateUI() {
            document.getElementById('scoreVal').innerText = '$' + (coinScore + timeScore).toLocaleString();
            document.getElementById('speedBar').style.width = (gameSpeed / 2.4 * 100) + '%';
        }

        function startGame() {
            audioManager.init(); audioManager.transitionToGame();
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('gameOverScreen').classList.add('hidden');
            isPlaying = true; score = 0; coinScore = 0; gameSpeed = 0.5;
            obstacles.forEach(o => scene.remove(o.mesh)); obstacles = [];
        }

        function gameOver() {
            isPlaying = false; audioManager.transitionToGameOver();
            document.getElementById('gameOverScreen').classList.remove('hidden');
            document.getElementById('finalScore').innerText = '$' + (coinScore + timeScore).toLocaleString();
        }

        function onWindowResize() { camera.aspect = window.innerWidth / window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }
        window.addEventListener('mousemove', e => mousePosNorm = e.clientX / window.innerWidth);
        window.addEventListener('touchstart', e => mousePosNorm = e.touches[0].clientX / window.innerWidth);
        
        window.onload = init;
    </script>
</body>
</html>
